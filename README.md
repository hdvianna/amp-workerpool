# Parallel Worker Pool

Parallel worker pool uses the PHP parallel extension 
to provide a simple interface for dealing with parallelization 
of tasks.

## Usage

The `WorkerPool` requires an implementation of the `WorkFactoryInterface` 
which is responsible for creating the _consumer_ and _producer closures_. 
A producer closure must return a [Generator](https://www.php.net/manual/en/class.generator.php).

### Composer installation

`composer require hdvianna/parallel-workerpool`

### Runing with Docker

`docker-compose up`

Docker compose will build an environment with the needed extensions installed and create a bind mount to the current directory.

### Example

In this example 10 workers will sleep for _n_ milliseconds, each time they 
consume the work generated by the WorkFactory. 

```php
use hdvianna\Concurrent\WorkFactoryInterface;

(new WorkerPool(new class implements WorkFactoryInterface {
    public function createWorkGeneratorClosure(): \Closure
    {
        return function () {
            for ($i = 0; $i < 100; $i++) {
                $work = new \stdClass();
                $work->time = mt_rand(300, 1000);
                $work->id = $i;
                yield $work;
            }
        };
    }

    public function createWorkConsumerClosure(): \Closure
    {
        return function($work) {
            printf("[$work->id]: Sleeping for %d milliseconds ...%s", $work->time, PHP_EOL);
            usleep($work->time * 1000);
            printf("[$work->id]: Woke up after %d milliseconds ...%s", $work->time, PHP_EOL);
        };
    }

}, 10))->run();
```  
